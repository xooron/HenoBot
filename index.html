<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Clicker Legacy</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- Иконки Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* (Твои стили остаются без изменений, добавляю только фикс для активных вкладок) */
        :root {
            --ton-blue: #0088cc;
            --ton-light: #24a1de;
            --bg-dark: #0a111a;
            --glass: rgba(255, 255, 255, 0.06);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #8e8e93;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; height: 100%; display: flex; flex-direction: column; position: relative; }
        .content { flex: 1; overflow-y: auto; padding: 20px 20px 120px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease forwards; }
        
        .card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; margin-bottom: 16px; }
        
        /* Навигация */
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; height: 75px; background: rgba(15, 21, 31, 0.9); backdrop-filter: blur(20px); border-radius: 25px; border: 1px solid var(--glass-border); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 600; transition: 0.3s; }
        .nav-item i { margin-bottom: 4px; width: 24px; height: 24px; }
        .nav-item.active { color: var(--ton-light); }

        .balance-pill { background: var(--glass); padding: 8px 16px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 800; }
        
        .inventory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .inventory-item { aspect-ratio: 1/1; border-radius: 12px; background: var(--glass); border: 1px solid var(--glass-border); overflow: hidden; }
        .inventory-item img { width: 100%; height: 100%; object-fit: cover; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app">
        <main class="content">
            <!-- GAME -->
            <section id="game" class="page active">
                <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                    <div class="balance-pill">
                        <i data-lucide="database"></i> <span id="balance-val">0</span> TON
                    </div>
                </div>
                <div class="card" onclick="tg.showAlert('Режим в разработке!')">
                    <h3 style="display:flex; align-items:center; gap:10px;"><i data-lucide="flame" color="#ff4500"></i> HELL PVP</h3>
                </div>
                <div class="card" onclick="tg.showAlert('Режим в разработке!')">
                    <h3 style="display:flex; align-items:center; gap:10px;"><i data-lucide="swords" color="#24a1de"></i> 1VS1 DUEL</h3>
                </div>
            </section>

            <!-- PROFILE -->
            <section id="profile" class="page">
                <div class="card">
                    <h2 id="user-name">Загрузка...</h2>
                    <p id="wallet-status" style="color: var(--ton-light);">Кошелек не подключен</p>
                    <button class="card" style="width:100%; margin-top:15px; background: white; color: black; font-weight: bold;" id="ton-connect-btn">
                        Подключить TON
                    </button>
                </div>
                <div class="card">
                    <h3><i data-lucide="package"></i> Инвентарь</h3>
                    <div id="inventory-list" class="inventory-grid" style="margin-top:15px;"></div>
                </div>
            </section>

            <!-- SHOP -->
            <section id="shop" class="page">
                <h1>Магазин</h1>
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>Desk Calendar</b><br><small>2.2 TON</small></div>
                    <button onclick="buyItem('desk', 2.2)" style="background:var(--ton-blue); color:white; border:none; padding:10px; border-radius:10px;">Купить</button>
                </div>
            </section>
        </main>

        <nav class="nav-bar">
            <a href="#" class="nav-item active" onclick="switchTab(event, 'game')">
                <i data-lucide="gamepad-2"></i><span>ИГРА</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab(event, 'profile')">
                <i data-lucide="user"></i><span>ПРОФИЛЬ</span>
            </a>
            <a href="#" class="nav-item" onclick="switchTab(event, 'shop')">
                <i data-lucide="shopping-cart"></i><span>МАГАЗИН</span>
            </a>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API_URL = 'http://localhost:3000/api'; // ЗАМЕНИ НА СВОЙ URL ПОСЛЕ ДЕПЛОЯ
        
        let currentUser = null;
        tg.expand();

        // Инициализация иконок
        lucide.createIcons();

        // Функция переключения вкладок
        function switchTab(event, tabId) {
            event.preventDefault();
            
            // Убираем активный класс у кнопок
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Добавляем активный класс нажатой кнопке
            event.currentTarget.classList.add('active');

            // Скрываем все страницы и показываем нужную
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            tg.HapticFeedback.selectionChanged();
        }

        // Авторизация на сервере
        async function initApp() {
            const user = tg.initDataUnsafe.user || { id: 12345, first_name: "Test", username: "tester" };
            
            try {
                const response = await fetch(`${API_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                currentUser = await response.json();
                updateUI();
            } catch (e) {
                console.error("Ошибка сервера:", e);
                tg.showAlert("Сервер недоступен");
            }
        }

        function updateUI() {
            if (!currentUser) return;
            document.getElementById('balance-val').innerText = currentUser.balance.toFixed(2);
            document.getElementById('user-name').innerText = currentUser.name;
            
            const invList = document.getElementById('inventory-list');
            invList.innerHTML = '';
            currentUser.inventory.forEach(imgUrl => {
                const div = document.createElement('div');
                div.className = 'inventory-item';
                div.innerHTML = `<img src="${imgUrl}">`;
                invList.appendChild(div);
            });
        }

        async function buyItem(type, price) {
            const img = type === 'desk' 
                ? "https://avatars.mds.yandex.net/i?id=11d7829a1ea8169feb71cfc7c9b51ab1537d5a11-4809781-images-thumbs&n=13" 
                : "https://avatars.mds.yandex.net/i?id=0c7ee6aab3038a0be3064868f97e2314037a1dfa-5888237-images-thumbs&n=13";

            try {
                const response = await fetch(`${API_URL}/buy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, itemType: type, price, imageUrl: img })
                });
                const result = await response.json();
                
                if (result.success) {
                    currentUser.balance = result.balance;
                    currentUser.inventory = result.inventory;
                    updateUI();
                    tg.showAlert("Успешная покупка!");
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.showAlert(result.error);
                }
            } catch (e) {
                tg.showAlert("Ошибка при покупке");
            }
        }

        // TON Connect
        const tonConnectUI = new TONConnectUI.TonConnectUI({
            manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/reusing-manifest/manifest.json',
            buttonRootId: 'ton-connect-btn'
        });

        initApp();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Candy Roulette</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter', sans-serif; }
        body { 
            background: #5a34a3; /* Фиолетовый фон как на фото */
            color: white; height: 100vh; overflow: hidden; 
        }

        #app { display: flex; flex-direction: column; height: 100%; max-width: 450px; margin: 0 auto; }
        .content { flex: 1; overflow-y: auto; padding: 20px; text-align: center; }
        .page { display: none; }
        .active { display: block; }

        /* Стиль Карамельки */
        .lollipop-container { position: relative; width: 280px; height: 380px; margin: 20px auto; display: flex; flex-direction: column; align-items: center; }
        .wheel-wrap { 
            position: relative; width: 250px; height: 250px; 
            border-radius: 50%; border: 5px solid #3c1e70; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 2;
        }
        #canvas { width: 100%; height: 100%; border-radius: 50%; transition: transform 8s cubic-bezier(0.15, 0, 0.15, 1); }
        .stick { 
            width: 14px; height: 140px; 
            background: #d64a7c; /* Розовая палочка */
            border-radius: 10px; transform: rotate(-15deg); 
            margin-top: -30px; border: 3px solid #3c1e70; z-index: 1;
        }
        .pointer { 
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%); 
            width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; 
            border-top: 30px solid white; z-index: 10; 
        }

        /* Глянец на карамельке */
        .wheel-wrap::after {
            content: ''; position: absolute; top: 15%; left: 15%; width: 35%; height: 20%;
            background: rgba(255,255,255,0.3); border-radius: 50%; filter: blur(8px); transform: rotate(-30deg); pointer-events: none;
        }

        /* UI */
        .bank-box { background: rgba(0,0,0,0.2); padding: 10px 20px; border-radius: 20px; display: inline-block; margin-bottom: 20px; }
        .bet-area { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .input-bet { background: #fff; border: none; padding: 12px; border-radius: 12px; width: 40%; color: #000; font-weight: bold; outline: none; }
        .btn-bet { background: #24a1de; color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 900; margin-left: 10px; }

        .profile-card { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .ava { width: 100px; height: 100px; border-radius: 50%; border: 4px solid #fff; margin-bottom: 15px; }

        .nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; height: 70px; background: #3c1e70; display: flex; justify-content: space-around; align-items: center; }
        .nav-item { color: rgba(255,255,255,0.5); text-decoration: none; font-size: 11px; text-align: center; }
        .nav-item.active { color: white; font-weight: bold; }

        /* Окно победителя */
        #win-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .win-box { background: white; color: black; padding: 40px; border-radius: 30px; text-align: center; }
    </style>
</head>
<body>

<div id="app">
    <div class="content">
        <!-- ИГРА -->
        <section id="p-game" class="page active">
            <h1 id="timer" style="font-size: 2.5rem; font-weight: 900; margin-bottom: 5px;">ОЖИДАНИЕ</h1>
            <div class="bank-box">Банк: <b id="bank-val">0.00</b> TON</div>

            <div class="lollipop-container">
                <div class="pointer"></div>
                <div class="wheel-wrap">
                    <canvas id="canvas" width="500" height="500"></canvas>
                </div>
                <div class="stick"></div>
            </div>

            <div class="bet-area">
                <input type="number" id="bet-input" class="input-bet" value="1.0">
                <button class="btn-bet" onclick="makeBet()">СТАВКА</button>
            </div>
            
            <div id="players-list" style="margin-top: 20px;"></div>
        </section>

        <!-- ПРОФИЛЬ -->
        <section id="p-profile" class="page">
            <div class="profile-card">
                <img id="my-ava" class="ava" src="">
                <h2 id="my-name">...</h2>
                <p id="my-username" style="color: rgba(255,255,255,0.6);">@...</p>
                <div style="margin-top: 20px; font-size: 1.5rem;">Баланс: <b id="my-balance" style="color:#2ecc71;">0</b> TON</div>
            </div>
        </section>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="tab('p-game')"><i data-lucide="gamepad-2"></i><div>ИГРА</div></div>
        <div class="nav-item" onclick="tab('p-profile')"><i data-lucide="user"></i><div>ПРОФИЛЬ</div></div>
    </nav>
</div>

<div id="win-modal">
    <div class="win-box">
        <h2 style="color: #5a34a3">ПОБЕДИТЕЛЬ!</h2>
        <img id="w-ava" style="width: 80px; height: 80px; border-radius: 50%; margin: 15px 0; border: 3px solid #5a34a3;">
        <div id="w-name" style="font-weight: 900;"></div>
        <h1 id="w-win" style="color: #2ecc71;"></h1>
        <button onclick="document.getElementById('win-modal').style.display='none'" style="margin-top: 15px; background: #5a34a3; color: white; border: none; padding: 10px 20px; border-radius: 10px;">ЗАКРЫТЬ</button>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'https://твой-бэкенд.onrender.com'; // Сюда вставь URL после деплоя
    let me = null;
    let spinning = false;

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    async function auth() {
        const user = tg.initDataUnsafe.user || { id: 1, first_name: "Gamer", username: "player" };
        const res = await fetch(`${API}/api/auth`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(user)
        });
        me = await res.json();
        updateMe();
    }

    function updateMe() {
        document.getElementById('my-ava').src = me.photo_url;
        document.getElementById('my-name').innerText = me.name;
        document.getElementById('my-username').innerText = '@' + me.username;
        document.getElementById('my-balance').innerText = me.balance.toFixed(2);
    }

    async function makeBet() {
        const val = parseFloat(document.getElementById('bet-input').value);
        if(!val || val <= 0) return;
        const res = await fetch(`${API}/api/bet`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ userId: me.id, amount: val })
        });
        const data = await res.json();
        if(data.success) {
            me.balance = data.balance;
            updateMe();
            tg.HapticFeedback.impactOccurred('medium');
        } else tg.showAlert(data.error);
    }

    // Отрисовка спирали карамельки
    function drawCandy() {
        ctx.clearRect(0,0,500,500);
        const colors = ['#3ec6f2', '#ffffff', '#e62e6b']; // Цвета с фото (голубой, белый, розовый)
        
        // Фоновый круг
        ctx.beginPath();
        ctx.arc(250, 250, 245, 0, Math.PI*2);
        ctx.fillStyle = '#fff';
        ctx.fill();

        // Рисуем спиральные сектора
        for (let i = 0; i < 12; i++) {
            ctx.beginPath();
            ctx.moveTo(250, 250);
            const startAngle = (i * Math.PI * 2) / 12;
            const endAngle = ((i + 1) * Math.PI * 2) / 12;
            
            ctx.arc(250, 250, 245, startAngle, endAngle);
            ctx.fillStyle = colors[i % 3];
            ctx.fill();
        }
    }

    function drawGame(players, total) {
        ctx.clearRect(0,0,500,500);
        let start = 0;
        players.forEach(p => {
            const slice = (p.bet / total) * 2 * Math.PI;
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.moveTo(250,250); ctx.arc(250,250,245, start, start+slice); ctx.fill();
            ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2; ctx.stroke();

            // Аватарка игрока на рулетке
            const mid = start + slice/2;
            const x = 250 + Math.cos(mid) * 170;
            const y = 250 + Math.sin(mid) * 170;
            
            ctx.save();
            ctx.beginPath(); ctx.arc(x,y,35,0,7); ctx.clip();
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.src = p.photo_url;
            try { ctx.drawImage(img, x-35, y-35, 70, 70); } catch(e){}
            ctx.restore();

            start += slice;
        });
    }

    async function sync() {
        const res = await fetch(`${API}/api/status`);
        const state = await res.json();

        document.getElementById('bank-val').innerText = state.totalBank.toFixed(2);
        const timerLabel = document.getElementById('timer');

        if(state.status === 'waiting') {
            timerLabel.innerText = 'ОЖИДАНИЕ';
            spinning = false;
            canvas.style.transition = 'none';
            canvas.style.transform = 'rotate(0deg)';
            drawCandy();
        } else if(state.status === 'countdown') {
            timerLabel.innerText = state.timer;
            drawGame(state.players, state.totalBank);
        } else if(state.status === 'spinning' && !spinning) {
            spinning = true;
            timerLabel.innerText = 'КРУТИМ!';
            canvas.style.transition = 'transform 8s cubic-bezier(0.15, 0, 0.15, 1)';
            canvas.style.transform = `rotate(${3600 + state.winningAngle}deg)`;
            
            setTimeout(() => {
                document.getElementById('w-ava').src = state.winner.photo_url;
                document.getElementById('w-name').innerText = state.winner.name;
                document.getElementById('w-win').innerText = '+' + state.totalBank.toFixed(2) + ' TON';
                document.getElementById('win-modal').style.display = 'flex';
                tg.HapticFeedback.notificationOccurred('success');
            }, 8500);
        }

        document.getElementById('players-list').innerHTML = state.players.map(p => `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px;">
                <span><b>${p.name}</b> (@${p.username})</span>
                <span style="color:#24a1de">${((p.bet/state.totalBank)*100).toFixed(1)}%</span>
            </div>
        `).join('');
    }

    function tab(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        event.currentTarget.classList.add('active');
        lucide.createIcons();
    }

    auth();
    lucide.createIcons();
    setInterval(sync, 1000);
</script>
</body>
</html>
